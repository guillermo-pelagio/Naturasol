
@{
    ViewBag.Title = "entradas_lote";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h3 style="text-align: center">Entradas con lote</h3>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-resumen" role="tabpanel" aria-labelledby="pills-resumen-tab">
                                <div class="col-lg-12 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body" style="margin-top: 0rem; padding: 0rem">

                                            <div class="table-responsive">
                                                <table class="table table-hover" id="tablaLotes" style="width: 100%">
                                                    <thead>
                                                        <tr>
                                                            <th>Acciones</th>
                                                            <th>Entrada</th>
                                                            <th>Fecha entrada</th>
                                                            <th>Clave proveedor</th>
                                                            <th>Nombre proveedor</th>
                                                            <th>Almacen</th>
                                                            <th>Nombre almacen</th>
                                                            <th>Estatus lote</th>
                                                            <th>Articulo</th>
                                                            <th>Descripcion</th>
                                                            <th>Lote</th>
                                                            <th>Caducidad</th>
                                                            <th>Cantidad</th>
                                                            <th>Lote proveedor</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        /*
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                alert('Your Public IP Address: '+ data.ip);
            })
            .catch(error => {
                console.error('Error fetching IP:', error);
            });
        */
        
        //LISTADO DE OF'S
        tablaLotes = $("#tablaLotes").DataTable({
            paging: true,
            ordering: false,
            info: true,
            lengthChange: false,
            pageLength: 25,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    title: 'Lotes-Entradas',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                    }
                },
            ],

            "ajax": {
                url: '@Url.Action("obtener_entradas", "calidad")',
                type: "GET",
                dataType: "json",
            },
            "columns": [
                { data: 'acciones' },
                { data: 'DocNum' },
                { data: 'DocDate' },
                { data: 'CardCode' },
                { data: 'CardName' },
                { data: 'WhsCode' },
                { data: 'nombreAlmacen' },
                {
                    data: 'Status', "render": function (Status) {
                        if (Status == "0") {
                            return '<span class="badge badge-success">LIBERADO</span>'
                        }
                        else if (Status == "1") {
                            return '<span class="badge badge-warning">EN ANALISIS</span>'
                        }
                        else if (Status == "2") {
                            return '<span class="badge badge-danger">BLOQUEADO</span>'
                        }
                        else {
                        }
                    }
                },
                { data: 'ItemCode' },
                { data: 'ItemName' },
                { data: 'BatchNum' },
                { data: 'ExpDate' },
                { data: 'Quantity' },
                { data: 'LoteProveedor' }
            ],
        });

        $("#tablaLotes").on("click", '#btnAceptar', function () {
            var filaseleccionada = $(this).closest("tr");
            var datos = tablaLotes.row(filaseleccionada).data();
            datos.Status = 1;
            cambiarEstatus(datos);
        });

        $("#tablaLotes").on("click", '#btnOK', function () {
            var filaseleccionada = $(this).closest("tr");
            var datos = tablaLotes.row(filaseleccionada).data();
            datos.Status = 0;
            cambiarEstatus(datos);
        });

        $("#tablaLotes").on("click", '#btnRechazar', function () {
            var filaseleccionada = $(this).closest("tr");
            var datos = tablaLotes.row(filaseleccionada).data();
            datos.Status = 2;
            cambiarEstatus(datos);
        });

        function cambiarEstatus(datos) {
            jQuery.ajax({
                url: '@Url.Action("validar_sesion", "Inicio")',
                type: "POST",
                dataType: "json",
                success: function (resultado) {
                    $('#overlay').css('display', 'none');
                    if (resultado == 1) {
                        $('#overlay').css('display', 'flex');
                        var componente2 = {
                            Status: datos.Status,
                            ItemCode: datos.ItemCode,
                            BatchNum: datos.BatchNum
                        }
                        jQuery.ajax(
                            {
                                url: '@Url.Action("actualizar_estatus", "calidad")',
                                type: "POST",
                                data: componente2,
                                success: function (resultado) {
                                    if (resultado == -1) {
                                        swal("", "Datos incorrectos!", "error");
                                    }
                                    else {
                                        swal("", "Estatus actualizado", "success")
                                            .then((value) => {
                                                window.location.reload(false);
                                            });
                                    }
                                },
                                error: function () {
                                    swal("", "Error al actualizar el estatus!", "error");
                                },
                            });
                        $('#overlay').css('display', 'none');

                    }
                    else {
                        alert('Sesion caducada');
                        window.location.reload(false);
                    }
                },
                error: function () {
                    $('#overlay').css('display', 'none');
                    swal("", "Sesión expirada!", "error")
                        .then((value) => {
                            window.location.reload(false);
                        });
                },
            });
        }

        //GUARDADO DE COTIZACION
        function guardadoLotes()
        {
            var isCorrect = true;

            var currentDate = new Date();
            var selectedDate = new Date($("#fechaCaducidadEdit").val());

            if ($("#fechaCaducidadEdit").val() == "") {
            swal("", "La fecha de vigencia de lote no puede ser vacia", "warning");
            isCorrect = false;
        }

        if (selectedDate<currentDate) {
            swal("", "La fecha de vigencia no puede ser anterior a hoy", "warning");
            isCorrect = false;
        }

            if ($("#loteProveedorEdit").val() == 0) {
                swal("", "Debes indicar un lote de proveedor", "warning");
                isCorrect = false;
            }


        if (isCorrect)
        {
            var lotesData = {
                ExpDate: $("#fechaCaducidadEdit").val(),
                LoteProveedor: $("#loteProveedorEdit").val(),
                ItemCode: $("#itemCodeEdit").val(),
                BatchNum: $("#loteSAPEdit").val()
                }

                $('#overlay').css('display', 'flex');
            jQuery.ajax(
                {
                    url: '@Url.Action("actualizar_lote", "calidad")',
                    type: "POST",
                    data: JSON.stringify(
                        {
                            detalleLote: lotesData
                        }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (resultado) {
                        if (resultado == -1) {
                            swal("", "Datos incorrectos!", "error");
                        }
                        else {
                            if ($("#idCotizacion").val() != 0) {
                                swal("", "Lote actualizado correctamente!", "success")
                                    .then((value) => {
                                        window.location.reload(false);
                                    });
                            }
                            else {
                                swal("", "Cotización insertada correctamente!", "success")
                                    .then((value) => {
                                        window.location.reload(false);
                                    });
                            }
                        }

                    },
                    error: function () {
                        swal("", "Error al insertar el paro!", "error")
                            .then((value) => {
                                window.location.reload(false);
                            });
                    },
                });
                $('#overlay').css('display', 'none');
            }
        }

    </script>
}
