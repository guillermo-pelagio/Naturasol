
@{
    ViewBag.Title = "reportes_cxp";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h3 style="text-align: center">Reportes CXP</h3>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-resumen" role="tabpanel" aria-labelledby="pills-resumen-tab">
                                <div class="col-lg-12 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body" style="margin-top: 0rem; padding: 0rem">

                                            <div class="table-responsive">
                                                <table class="table table-hover" id="tablaReportes" style="width: 100%">
                                                    <thead>
                                                        <tr>
                                                            <th>Abrir reporte</th>
                                                            <th>Nombre</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>

        tablaReportes = $("#tablaReportes").DataTable({
            paging: true,
            ordering: false,
            info: true,
            lengthChange: false,
            pageLength: 25,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
            },

            "ajax": {
                url: '@Url.Action("obtener_reportes", "cxp")',
                type: "GET",
                dataType: "json",
            },
            "columns": [
                {
                    data: 'queryReporte', "render": function (queryReporte) {
                        if (queryReporte.includes("app.powerbi.com"))  {
                            return '<button type="button" id="btn-visualizar-reporte" class="btn btn-warning" style="padding: 0.5rem; border-radius: 5px;"><i class="fa fa-chart-simple" aria-hidden="true"></i></button>'
                        }
                        if (queryReporte.includes(".xlsx")) {
                            return '<button type="button" id="btn-exportar-reporte" class="btn btn-primary" style="padding: 0.5rem; border-radius: 5px;"><i class="fa fa-download" aria-hidden="true"></i></button>'
                        }
                        else
                            return '<button type="button" id="btn-exportar-reporte" class="btn btn-success" style="padding: 0.5rem; border-radius: 5px;"><i class="fa fa-download" aria-hidden="true"></i></button>'
                    }
                },
                { data: 'nombreReporte' }
            ],
        });

        $("#tablaReportes").on("click", '#btn-exportar-reporte', function () {
            var filaseleccionada = $(this).closest("tr");
            var datos = tablaReportes.row(filaseleccionada).data();
            crearReporte(datos.idReporte);
        });


        $("#tablaReportes").on("click", '#btn-visualizar-reporte', function () {
            var filaseleccionada = $(this).closest("tr");
            var datos = tablaReportes.row(filaseleccionada).data();
            visualizarReporte(datos.idReporte);
        });

        function crearReporte(idReporte)
        {
            jQuery.ajax(
            {
                url: '@Url.Action("validar_sesion", "Inicio")',
                type: "POST",
                dataType: "json",
                success: function(resultado)
                {
                    $('#overlay').css('display', 'none');
                    if (resultado == 1)
                    {
                        window.open('/reportes/obtener_excel?idReporte=' + idReporte, '_blank');
                    }
                    else
                    {
                        alert('Sesion caducada');
                        window.location.reload(false);
                    }
                },
                error: function()
                {
                    $('#overlay').css('display', 'none');
                    swal("", "Sesión expirada!", "error")
                        .then((value) =>
                        {
                            window.location.reload(false);
                        });
                },
            });
        }


        function visualizarReporte(idReporte)
        {

            jQuery.ajax(
            {
                url: '@Url.Action("validar_sesion", "Inicio")',
                type: "POST",
                dataType: "json",
                success: function(resultado)
                {
                    $('#overlay').css('display', 'none');
                    if (resultado == 1)
                    {
                        window.open('/reportes/reporte_bi?idReporte=' + idReporte, '_blank');
                    }
                    else
                    {
                        alert('Sesion caducada');
                        window.location.reload(false);
                    }
                },
                error: function()
                {
                    $('#overlay').css('display', 'none');
                    swal("", "Sesión expirada!", "error")
                        .then((value) =>
                        {
                            window.location.reload(false);
                        });
                },
            });
        }

    </script>
}
